<div class="p-4">
    <div class="flex justify-content-between align-items-center mb-4">
        <h2 class="text-2xl font-bold text-900 m-0">{{ editMode ? 'Modifier' : 'Nouveau' }} Client Moral</h2>
        <div class="flex gap-2">
            <p-button label="Annuler" severity="secondary" (onClick)="cancel()" icon="pi pi-times"></p-button>
            <p-button label="Enregistrer" (onClick)="save()" icon="pi pi-check"
                [disabled]="!client.ice || !client.raisonSociale"></p-button>
        </div>
    </div>

    <div class="card p-4 glass">
        <p-tabs value="0">
            <p-tablist>
                <p-tab value="0">
                    <i class="pi pi-building mr-2"></i>
                    Informations
                </p-tab>
                <p-tab value="1" *ngIf="editMode && client.id">
                    <i class="pi pi-folder mr-2"></i>
                    Documents
                </p-tab>
            </p-tablist>
            <p-tabpanels>
                <p-tabpanel value="0">
                    <p-fluid>
                        <div class="grid">
                            <!-- Identité -->
                            <div class="col-12 text-xl font-bold mb-3">Informations Légales</div>
                            <div class="col-12 md:col-6 field">
                                <label class="font-medium">ICE</label>
                                <input pInputText [(ngModel)]="client.ice" (blur)="checkIce()" [disabled]="editMode" />
                                <small class="p-error" *ngIf="iceExists">Cet ICE existe déjà</small>
                            </div>
                            <div class="col-12 md:col-6 field">
                                <label class="font-medium">Raison Sociale</label>
                                <input pInputText [(ngModel)]="client.raisonSociale" />
                            </div>

                            <div class="col-12 md:col-6 field">
                                <label class="font-medium">Registre de Commerce (RC)</label>
                                <input pInputText [(ngModel)]="client.rc" (blur)="checkRc()" />
                                <small class="text-orange-500" *ngIf="rcExists">Ce RC existe déjà (Attention)</small>
                            </div>
                            <div class="col-12 md:col-6 field">
                                <label class="font-medium">Identifiant Fiscal (IF)</label>
                                <input pInputText [(ngModel)]="client.identifiantFiscal" (blur)="checkIf()" />
                                <small class="text-orange-500" *ngIf="ifExists">Cet IF existe déjà (Attention)</small>
                            </div>

                            <div class="col-12 md:col-6 field">
                                <label class="font-medium">Forme Juridique</label>
                                <input pInputText [(ngModel)]="client.formeJuridique" placeholder="SARL, SA..." />
                            </div>
                            <div class="col-12 md:col-6 field">
                                <label class="font-medium">Siège Social (Principal)</label>
                                <input pInputText [(ngModel)]="client.siegeSocial" />
                            </div>

                            <div class="col-12 md:col-6 field mb-4 flex align-items-end">
                                <div class="flex align-items-center gap-2">
                                    <input type="checkbox" id="lotisseur" [(ngModel)]="client.isLotisseur" />
                                    <label for="lotisseur" class="font-medium">Lotisseur</label>
                                </div>
                            </div>
                            <div class="col-12 md:col-6 field" *ngIf="client.isLotisseur">
                                <label class="font-medium">Numéro d'agrément Lotisseur</label>
                                <input pInputText [(ngModel)]="client.numeroAgrementLotisseur" />
                            </div>

                            <!-- Contact -->
                            <div class="col-12 text-xl font-bold mt-4 mb-3">Contact</div>
                            <div class="col-12 md:col-6 field">
                                <label class="font-medium">Téléphone</label>
                                <input pInputText [(ngModel)]="client.telephone" />
                            </div>
                            <div class="col-12 md:col-6 field">
                                <label class="font-medium">Email</label>
                                <input pInputText [(ngModel)]="client.email" />
                            </div>

                            <!-- Adresses -->
                            <div class="col-12 text-xl font-bold mt-4 mb-3">Autres Adresses (Succursales)</div>
                            <div class="col-12">
                                <p-table [value]="client.adresses || []"
                                    styleClass="p-datatable-sm p-datatable-gridlines">
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>Adresse</th>
                                            <th>Ville</th>
                                            <th>Code Postal</th>
                                            <th>Pays</th>
                                            <th style="width: 100px">Actions</th>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-addr let-i="rowIndex">
                                        <tr>
                                            <td>{{addr.adresse}}</td>
                                            <td>{{addr.ville}}</td>
                                            <td>{{addr.codePostal}}</td>
                                            <td>{{addr.pays}}</td>
                                            <td>
                                                <p-button icon="pi pi-trash" [rounded]="true" [text]="true"
                                                    severity="danger" (onClick)="removeAdresse(i)"></p-button>
                                            </td>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                            <td colspan="5" class="text-center">Aucune adresse supplémentaire.</td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                                <div class="mt-2">
                                    <p-button label="Ajouter Adresse" icon="pi pi-plus" [outlined]="true"
                                        (onClick)="showAdresseDialog = true"></p-button>
                                </div>
                            </div>
                        </div>
                    </p-fluid>
                </p-tabpanel>
                <p-tabpanel value="1" *ngIf="editMode && client.id">
                    <app-file-explorer [clientId]="client.id"></app-file-explorer>
                </p-tabpanel>
            </p-tabpanels>
        </p-tabs>
    </div>

    <p-dialog [(visible)]="showAdresseDialog" header="Nouvelle Adresse" [modal]="true" [style]="{width: '450px'}">
        <p-fluid>
            <div class="field">
                <label>Adresse</label>
                <textarea pTextarea [(ngModel)]="newAdresse.adresse" rows="3"></textarea>
            </div>
            <div class="field grid">
                <div class="col-6">
                    <label>Ville</label>
                    <input pInputText [(ngModel)]="newAdresse.ville" />
                </div>
                <div class="col-6">
                    <label>Code Postal</label>
                    <input pInputText [(ngModel)]="newAdresse.codePostal" />
                </div>
            </div>
            <div class="field">
                <label>Pays</label>
                <input pInputText [(ngModel)]="newAdresse.pays" />
            </div>
        </p-fluid>
        <ng-template pTemplate="footer">
            <p-button label="Annuler" icon="pi pi-times" [text]="true" (onClick)="showAdresseDialog = false"></p-button>
            <p-button label="Ajouter" icon="pi pi-check" (onClick)="addAdresse()"
                [disabled]="!newAdresse.adresse || !newAdresse.ville"></p-button>
        </ng-template>
    </p-dialog>

    <p-toast></p-toast>
</div>